const SUPABASE_URL="https://kycmnkibuxtzrbzrhezo.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5Y21ua2lidXh0enJienJoZXpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODI3NDAsImV4cCI6MjA3NzA1ODc0MH0.WtZhCS8qRUQNX5cSJAKdyA4G7Df7izGeWcjbWZTSbE4",supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY),supabaseRealtimeClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);let realtimeChannel=null,transaksi=JSON.parse(localStorage.getItem("transaksi"))||[],editIndex=null,currentFilteredDate=null,currentConfirmCallback=null,itemRowCounter=0,currentPage=1;const transactionsPerPage=10;let cameraStream=null,cropper=null;function initTheme(){const e=localStorage.getItem("colorTheme")||"ocean",t=localStorage.getItem("customAccentColor"),n=document.getElementById("custom-color-input");n&&(n.value="custom"===e&&t?t:"#4f46e5")}function toggleTheme(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)}function applyColorTheme(e){document.documentElement.style.removeProperty("--primary-gradient"),document.documentElement.style.removeProperty("--primary-accent-color"),document.documentElement.style.removeProperty("--primary-accent-color-glow"),document.documentElement.setAttribute("data-color-theme",e),localStorage.setItem("colorTheme",e),localStorage.removeItem("customAccentColor");showNotification(`Tema ${e.charAt(0).toUpperCase()+e.slice(1)} diterapkan`,"success"),updateActiveThemeButton(e),updateActiveSwatch();const t=document.getElementById("custom-color-input");t&&(t.value="#4f46e5")}function resetColorTheme(){applyColorTheme("ocean"),showNotification("Tema dikembalikan ke default","info")}function lightenHexColor(e,t){e=e.replace(/^#/,"");const n=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),o=parseInt(e.substring(4,6),16),i=Math.min(255,n+t/100*(255-n)),l=Math.min(255,a+t/100*(255-a)),r=Math.min(255,o+t/100*(255-o));return`#${Math.round(i).toString(16).padStart(2,"0")}${Math.round(l).toString(16).padStart(2,"0")}${Math.round(r).toString(16).padStart(2,"0")}`}function generateGradient(e){return`linear-gradient(135deg, ${e} 0%, ${lightenHexColor(e,30)} 100%)`}function hexToRgba(e,t=1){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}function updateActiveThemeButton(e){document.querySelectorAll(".theme-option").forEach(t=>{t.classList.toggle("active",t.dataset.themeName===e)})}function initializeCustomColorPalette(){const e=document.getElementById("color-palette");if(!e)return;e.innerHTML="",[{name:"Slate",value:"#475569"},{name:"Sky",value:"#0ea5e9"},{name:"Emerald",value:"#10b981"},{name:"Amber",value:"#f59e0b"},{name:"Rose",value:"#f43f5e"},{name:"Indigo",value:"#4f46e5"}].forEach(t=>{const n=document.createElement("button");n.className="color-swatch",n.style.backgroundColor=t.value,n.title=t.name,n.dataset.color=t.value,n.addEventListener("click",()=>{const e=n.dataset.color;generateGradient(e);applyCustomColor(e),showNotification(`Warna kustom ${t.name} diterapkan`,"success")}),e.appendChild(n)})}function updateActiveSwatch(){document.querySelectorAll(".color-swatch").forEach(e=>e.classList.remove("active"));const e=localStorage.getItem("colorTheme"),t=localStorage.getItem("customAccentColor");if("custom"===e&&t){const e=document.querySelector(`.color-swatch[data-color="${t}"]`);e&&e.classList.add("active"),updateActiveThemeButton(null)}}function handleProfilePhotoChange(e){if(!checkLoginStatus())return void(e.target.value=null);const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(e){const t=document.getElementById("profile-photo"),n=document.getElementById("profile-placeholder");t.src=e.target.result,t.classList.add("show"),n.classList.add("hide"),localStorage.setItem("profilePhoto",e.target.result),showNotification("Foto profil berhasil diperbarui","success")},e.readAsDataURL(t)}}function loadProfilePhoto(){const e=localStorage.getItem("profilePhoto");if(e){const t=document.getElementById("profile-photo"),n=document.getElementById("profile-placeholder");t.src=e,t.classList.add("show"),n.classList.add("hide")}}function editTitle(){if(!checkLoginStatus())return;const e=document.getElementById("app-title"),t=document.getElementById("title-edit-modal"),n=document.getElementById("title-edit-input");n.value=e.textContent,t.classList.add("show"),setTimeout(()=>{n.focus(),n.select()},100)}function closeTitleEditModal(){document.getElementById("title-edit-modal").classList.remove("show")}function saveTitleFromModal(){const e=document.getElementById("app-title"),t=document.getElementById("title-edit-input").value.trim();t&&(e.textContent=t,localStorage.setItem("appTitle",t),showNotification("Nama aplikasi berhasil diubah","success")),closeTitleEditModal()}function loadAppTitle(){const e=localStorage.getItem("appTitle");e&&(document.getElementById("app-title").textContent=e)}document.addEventListener("DOMContentLoaded",function(){document.getElementById("title-edit-input").addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),saveTitleFromModal()):"Escape"===e.key&&closeTitleEditModal()});const e=document.getElementById("title-edit-modal");e.addEventListener("click",function(t){t.target===e&&closeTitleEditModal()}),document.getElementById("confirmActionBtn").addEventListener("click",()=>{currentConfirmCallback&&(currentConfirmCallback(),currentConfirmCallback=null),closeConfirmationModal()}),initializeCustomColorPalette()});const form=document.getElementById("form-transaksi"),cancelEditBtn=document.getElementById("cancel-edit-btn"),submitBtn=document.getElementById("submit-btn"),submitText=document.getElementById("submit-text"),formTitle=document.getElementById("form-title"),emptyState=document.getElementById("empty-state"),pdfSettingsModal=document.getElementById("pdfSettingsModal"),deleteModal=document.getElementById("deleteModal"),pdfOrientationSelect=document.getElementById("pdf-orientation"),pdfFilenameInput=document.getElementById("pdf-filename"),pdfModalBtn=document.getElementById("pdf-modal-btn"),confirmationModal=document.getElementById("confirmationModal"),confirmationModalMessage=document.getElementById("confirmationModalMessage"),importModal=document.getElementById("importModal"),importFileInput=document.getElementById("import-file"),confirmImportBtn=document.getElementById("confirm-import-btn"),dataActionsDropdown=document.getElementById("data-actions-dropdown"),dataActionsToggleBtn=document.getElementById("data-actions-toggle-btn"),calendarFilterIcon=document.getElementById("calendar-filter-icon"),hiddenDateFilterInput=document.getElementById("hidden-date-filter"),activeDateFilterDisplay=document.getElementById("active-date-filter-display"),clearDateFilterBtn=document.getElementById("clear-date-filter-btn"),deleteFilterSelect=document.getElementById("delete-filter"),dateRangeDeleteGroup=document.getElementById("date-range-delete-group"),deleteStartDateInput=document.getElementById("delete-start-date"),deleteEndDateInput=document.getElementById("delete-end-date"),themeSettingsModal=document.getElementById("themeSettingsModal");function setTodayDate(){const e=(new Date).toISOString().split("T")[0];document.getElementById("tanggal").value=e}function setupMidnightDateUpdate(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1),t.setHours(0,0,0,0);const n=t.getTime()-e.getTime();setTimeout(()=>{setTodayDate(),setInterval(()=>{setTodayDate()},864e5)},n)}function setupEventListeners(){cancelEditBtn.addEventListener("click",cancelEdit);const e=document.getElementById("settings-menu"),t=document.getElementById("settings-menu-toggle"),n=document.getElementById("open-theme-modal-btn");e&&t&&n&&(t.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("open")}),n.addEventListener("click",()=>{openThemeModal(),e.classList.remove("open")}),window.addEventListener("click",t=>{e.contains(t.target)||e.classList.remove("open")})),document.querySelectorAll(".quick-amount-btn").forEach(e=>{e.addEventListener("click",function(){document.getElementById("jumlah").value=this.dataset.amount,this.style.background="var(--border)",setTimeout(()=>{this.style.background="var(--background-secondary)"},200)})}),dataActionsToggleBtn.addEventListener("click",()=>{dataActionsDropdown.classList.toggle("open")}),window.addEventListener("click",function(e){dataActionsDropdown.contains(e.target)||dataActionsDropdown.classList.remove("open")}),document.getElementById("filter-bulan").addEventListener("change",()=>{currentPage=1,updateUI()});const a=document.getElementById("search-input"),o=document.getElementById("search-clear"),i=debounce(()=>{currentPage=1,updateUI()},300);a.addEventListener("input",function(){const e=this.value.trim();o.style.display=e?"flex":"none",i()}),document.getElementById("deskripsi").addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),document.getElementById("jumlah").focus())}),document.getElementById("jumlah").addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),document.getElementById("tanggal").focus())}),window.addEventListener("click",function(e){e.target==themeSettingsModal&&closeThemeModal(),e.target==pdfSettingsModal&&closePdfSettingsModal(),e.target==deleteModal&&closeDeleteModal(),e.target==importModal&&closeImportModal(),e.target==confirmationModal&&closeConfirmationModal(),e.target==document.getElementById("login-modal")&&closeLoginModal()}),calendarFilterIcon.addEventListener("click",()=>{hiddenDateFilterInput.showPicker()}),hiddenDateFilterInput.addEventListener("change",function(){currentPage=1,currentFilteredDate=this.value,updateUI(),updateDateFilterDisplay()}),clearDateFilterBtn.addEventListener("click",clearDateFilter),importFileInput.addEventListener("change",function(){confirmImportBtn.disabled=0===this.files.length}),confirmImportBtn.disabled=!0,deleteFilterSelect.addEventListener("change",function(){if("custom-range"===this.value){if(dateRangeDeleteGroup.style.display="block",deleteStartDateInput.value||(deleteStartDateInput.value="2000-01-01"),!deleteEndDateInput.value){const e=new Date;deleteEndDateInput.value=e.toISOString().split("T")[0]}}else dateRangeDeleteGroup.style.display="none"}),setupScanEventListeners();const l=document.getElementById("custom-color-input");l&&l.addEventListener("input",e=>{applyCustomColor(e.target.value)})}function setupScanEventListeners(){const e=document.getElementById("scan-modal"),t=document.getElementById("scanner-help-btn"),n=document.getElementById("toggle-edit-btn"),a=document.getElementById("toggle-image-btn");document.getElementById("scan-receipt-btn").addEventListener("click",openScanner),document.getElementById("capture-btn").addEventListener("click",captureImage),document.getElementById("rescan-btn").addEventListener("click",resetScanner),document.getElementById("cancel-scan-btn").addEventListener("click",closeScanner),document.getElementById("save-scanned-btn").addEventListener("click",saveScannedTransaction),document.getElementById("add-item-btn").addEventListener("click",()=>addScannedItemRow()),t.addEventListener("click",()=>{showNotification("\n                <div style='text-align: left;'>\n                    <b style='display: block; margin-bottom: 8px; font-size: 1.1em;'>üí° Tips untuk Hasil Pindai Terbaik</b>\n                    <ul style='margin: 0; padding-left: 20px;'>\n                        <li style='margin-bottom: 5px;'><b>Cahaya Terang:</b> Pastikan struk berada di area dengan pencahayaan yang baik dan merata.</li>\n                        <li style='margin-bottom: 5px;'><b>Permukaan Datar:</b> Letakkan struk di atas permukaan yang rata dan tidak terlipat.</li>\n                        <li style='margin-bottom: 5px;'><b>Hindari Bayangan:</b> Posisikan kamera agar tidak ada bayangan dari tangan atau ponsel Anda yang menutupi struk.</li>\n                        <li style='margin-bottom: 5px;'><b>Fokus & Jelas:</b> Pastikan kamera fokus dan seluruh teks pada struk terlihat tajam dan tidak buram sebelum mengambil gambar.</li>\n                        <li style='margin-bottom: 0;'><b>Isi Bingkai:</b> Posisikan struk agar memenuhi area di dalam bingkai pemindai.</li>\n                    </ul>\n                </div>\n            ","info",null)}),n.addEventListener("click",()=>setCorrectionView("edit")),a.addEventListener("click",()=>setCorrectionView("image")),e.addEventListener("click",t=>{t.target===e&&closeScanner()})}async function openScanner(){if(!checkLoginStatus())return;document.getElementById("scan-modal").style.display="flex",resetScannerState();try{const e={video:{facingMode:"environment"}};cameraStream=await navigator.mediaDevices.getUserMedia(e);document.getElementById("camera-view").srcObject=cameraStream}catch(e){console.error("Error accessing camera: ",e);let t="Gagal mengakses kamera.";"NotAllowedError"===e.name&&(t="Akses kamera ditolak. Silakan izinkan akses kamera di pengaturan browser Anda untuk menggunakan fitur ini."),showNotification(t,"error",6e3),closeScanner()}}function closeScanner(){cameraStream&&(cameraStream.getTracks().forEach(e=>e.stop()),cameraStream=null),cropper&&(cropper.destroy(),cropper=null),document.getElementById("scan-modal").style.display="none"}function resetScannerState(){document.getElementById("scanner-title").textContent="Pindai Struk Belanja",document.getElementById("scanner-view-container").style.display="block",document.getElementById("cropper-container").style.display="none",document.getElementById("scanner-results-container").style.display="none",document.getElementById("capture-btn").style.display="inline-flex",document.getElementById("preview-controls").style.display="none",document.getElementById("correction-controls").style.display="none",document.getElementById("ocr-status").style.display="none",document.getElementById("item-list-container").innerHTML=""}function captureImage(){const e=document.getElementById("camera-view"),t=document.getElementById("image-preview-canvas"),n=document.getElementById("image-to-crop");t.width=e.videoWidth,t.height=e.videoHeight;t.getContext("2d").drawImage(e,0,0,t.width,t.height),n.src=t.toDataURL("image/jpeg"),document.getElementById("scanner-view-container").style.display="none",document.getElementById("cropper-container").style.display="block",cropper&&cropper.destroy(),cropper=new Cropper(n,{viewMode:1,background:!1,responsive:!0,autoCropArea:.9}),document.getElementById("capture-btn").style.display="none";const a=document.getElementById("process-btn");a.querySelector("#process-btn-text").innerHTML="‚úÇÔ∏è Crop & Proses",a.onclick=processCroppedImage,document.getElementById("preview-controls").style.display="flex"}function resetScanner(){cropper&&(cropper.destroy(),cropper=null),resetScannerState()}async function processCroppedImage(){if(!cropper)return void showNotification("Cropper tidak siap.","error");const e=document.getElementById("ocr-status"),t=document.getElementById("ocr-status-text"),n=document.getElementById("ocr-progress"),a=document.getElementById("process-btn"),o=cropper.getCroppedCanvas({fillColor:"#fff"});if(o){document.getElementById("cropper-container").style.display="none",document.getElementById("preview-controls").style.display="none",e.style.display="block",t.textContent="Mempersiapkan pemindaian...",n.value=0,a.disabled=!0,a.querySelector("#process-btn-text").innerHTML='<span class="loading"></span> Memproses...';try{const e=await Tesseract.createWorker("ind",1,{logger:e=>{n.value=100*(e.progress||0),"recognizing text"===e.status&&(t.textContent=`Menganalisis teks... (${Math.round(100*e.progress)}%)`)}}),{data:{text:a}}=await e.recognize(o);await e.terminate(),parseOCRText(a),document.getElementById("scanner-title").textContent="Koreksi Hasil Pindaian",document.getElementById("scanner-results-container").style.display="flex",document.getElementById("correction-controls").style.display="flex",document.getElementById("receipt-image-display").src=o.toDataURL(),setCorrectionView("edit")}catch(e){console.error("OCR Error:",e),showNotification("Terjadi kesalahan saat pemindaian OCR.","error"),resetScanner()}finally{e.style.display="none",a.disabled=!1,a.querySelector("#process-btn-text").innerHTML="‚úÇÔ∏è Crop & Proses"}}else showNotification("Gagal mendapatkan gambar hasil crop.","error")}function parseOCRText(e){const t=e.replace(/(\d)[.,](\d{3})/g,"$1$2").replace(/,00/g,"").replace(/Rp\s?/gi,"").replace(/[^\w\s.,-]/g,"").split("\n"),n=[],a=/^(.+?)\s+(?:x\s?)?\d{1,2}\s+(\d{4,})$/,o=/^(.*?)\s+(\d{4,})$/,i=/(Total|Subtotal|Tunai|Kembali|PPN|Diskon|Kasir|Indomaret|Alfamart|Alfamidi|Member|Poin|Tgl|Wkt|Struk|Telp)/i;t.forEach(e=>{if((e=e.trim()).length<5||i.test(e))return;let t=e.match(a)||e.match(o);if(t){let e=t[1].replace(/\d+$/,"").trim(),a=parseInt(t[t.length-1],10);e.length>2&&/[a-zA-Z]{2,}/.test(e)&&!isNaN(a)&&a>0&&n.push({name:e,price:a})}}),displayScannedItems(n)}function displayScannedItems(e){document.getElementById("item-list-container").innerHTML="",0===e.length?(showNotification("Tidak ada item yang terdeteksi. Silakan tambah manual.","warning"),addScannedItemRow()):(showNotification(`Terdeteksi ${e.length} item. Mohon periksa kembali.`,"success"),e.forEach(e=>addScannedItemRow(e.name,e.price))),updateScannedTotal()}function addScannedItemRow(e="",t=""){const n=document.getElementById("item-list-container"),a=document.createElement("div");a.className="item-row";const o=++itemRowCounter;a.innerHTML=`\n        <div class="item-details-wrapper">\n            <div class="item-input-group item-name-group">\n                <label for="item-name-${o}">Nama Barang</label>\n                <input type="text" id="item-name-${o}" class="input-field item-name-input" value="${e}" placeholder="Contoh: Indomie Goreng">\n            </div>\n            <div class="item-input-group item-price-group">\n                <label for="item-price-${o}">Harga</label>\n                <input type="number" id="item-price-${o}" class="input-field item-price-input" value="${t}" placeholder="15000" inputmode="numeric">\n            </div>\n        </div>\n        <button class="delete-item-btn" onclick="this.parentElement.remove(); updateScannedTotal();" title="Hapus item ini">‚úï</button>\n      `,n.appendChild(a);const i=a.querySelector(".item-price-input");i.addEventListener("input",updateScannedTotal);const l=e=>{setTimeout(()=>{e.target.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},300)};a.querySelector(".item-name-input").addEventListener("focus",l),i.addEventListener("focus",l)}function updateScannedTotal(){const e=document.querySelectorAll(".item-price-input");let t=0;e.forEach(e=>{t+=parseInt(e.value)||0}),document.getElementById("total-scanned-amount").textContent=formatCurrency(t)}function setCorrectionView(e){const t=document.getElementById("item-list-wrapper"),n=document.getElementById("receipt-image-wrapper"),a=document.getElementById("toggle-edit-btn"),o=document.getElementById("toggle-image-btn");"edit"===e?(t.style.display="block",n.style.display="none",a.classList.add("active"),o.classList.remove("active")):(t.style.display="none",n.style.display="block",a.classList.remove("active"),o.classList.add("active"))}function saveScannedTransaction(){const e=document.querySelectorAll(".item-row");if(0===e.length)return void showNotification("Tidak ada item untuk disimpan.","error");let t=0;const n=(new Date).toISOString().split("T")[0];e.forEach(e=>{const a=e.querySelector(".item-name-input").value.trim(),o=parseInt(e.querySelector(".item-price-input").value)||0;if(a&&o>0){const e={deskripsi:a,jumlah:o,tanggal:n,jenis:"pengeluaran"};transaksi.push(e),t++}}),t>0?(localStorage.setItem("transaksi",JSON.stringify(transaksi)),updateUI(),closeScanner(),showNotification(`${t} transaksi dari struk berhasil disimpan!`,"success")):showNotification("Tidak ada item valid untuk disimpan.","error")}function clearSearch(){const e=document.getElementById("search-input"),t=document.getElementById("search-clear");e.value="",t.style.display="none",currentPage=1,updateUI(),e.focus()}function clearDateFilter(){currentFilteredDate=null,hiddenDateFilterInput.value="",updateDateFilterDisplay(),currentPage=1,updateUI(),showNotification("Filter tanggal dihapus","info")}function updateDateFilterDisplay(){currentFilteredDate?(activeDateFilterDisplay.textContent=`(${formatDate(currentFilteredDate)})`,activeDateFilterDisplay.style.display="inline",clearDateFilterBtn.style.display="inline"):(activeDateFilterDisplay.textContent="",activeDateFilterDisplay.style.display="none",clearDateFilterBtn.style.display="none")}function handleFormSubmit(e){if(e.preventDefault(),!checkLoginStatus())return;const t=document.getElementById("deskripsi").value.trim(),n=parseFloat(document.getElementById("jumlah").value),a=document.getElementById("tanggal").value,o=document.getElementById("jenis").value;t&&n&&a?n<=0?showNotification("Jumlah tidak valid","error"):(submitText.innerHTML='<span class="loading"></span> Menyimpan...',submitBtn.disabled=!0,setTimeout(()=>{null!==editIndex?(transaksi[editIndex]={deskripsi:t,jumlah:n,tanggal:a,jenis:o},showNotification("Transaksi berhasil diupdate","success"),cancelEdit()):(transaksi.push({deskripsi:t,jumlah:n,tanggal:a,jenis:o}),showNotification("Transaksi berhasil ditambahkan","success")),localStorage.setItem("transaksi",JSON.stringify(transaksi)),form.reset(),setTodayDate(),updateUI(),submitText.textContent="Simpan Transaksi",submitBtn.disabled=!1,document.getElementById("deskripsi").focus()},500)):showNotification("Data tidak lengkap","error")}function cancelEdit(){editIndex=null,form.reset(),setTodayDate(),formTitle.textContent="üìù Tambah Transaksi Baru",submitText.textContent="Simpan Transaksi",cancelEditBtn.style.display="none",document.getElementById("deskripsi").focus(),showNotification("Edit dibatalkan","info")}function updateUI(){if("true"!==localStorage.getItem("isLoggedIn"))return void loadGuestUI();const e=document.getElementById("empty-state");e.innerHTML='\n    <div class="empty-state-icon">üìä</div>\n    <h3>Belum ada transaksi</h3>\n    <p>Mulai tambahkan transaksi pertama Anda!</p>\n  ',updateSummaryCards(),updateTransactionsTable(),updateMonthFilter(),updateDateFilterDisplay();document.getElementById("tbody-tabel");0!==getFilteredTransactions().length||""!==document.getElementById("search-input").value.trim()||currentFilteredDate?(e.style.display="none",document.querySelector(".table-container table").style.display="table"):(e.style.display="block",document.querySelector(".table-container table").style.display="none")}function updateSummaryCards(){let e=0,t=0;getFilteredTransactions().forEach(n=>{"pemasukan"===n.jenis&&(e+=n.jumlah),"pengeluaran"===n.jenis&&(t+=n.jumlah)});const n=e-t,a=document.getElementById("pemasukan"),o=document.getElementById("pengeluaran"),i=document.getElementById("saldo");a.classList.add("value-updated"),o.classList.add("value-updated"),i.classList.add("value-updated"),setTimeout(()=>{a.classList.remove("value-updated"),o.classList.remove("value-updated"),i.classList.remove("value-updated")},400),a.textContent=formatCurrency(e),o.textContent=formatCurrency(t),i.textContent=formatCurrency(n)}function getFilteredTransactions(){const e=document.getElementById("filter-bulan").value,t=document.getElementById("search-input").value.toLowerCase().trim();return transaksi.filter(n=>{const a="semua"===e||n.tanggal.startsWith(e),o=new Date(n.tanggal),i=o.getFullYear().toString(),l=o.toLocaleString("id-ID",{month:"long"}).toLowerCase(),r=!isNaN(t)&&""!==t,s=!t||n.deskripsi.toLowerCase().includes(t)||n.jenis.toLowerCase().includes(t)||r&&(i.includes(t)||n.jumlah.toString().includes(t))||l.includes(t),d=!currentFilteredDate||n.tanggal===currentFilteredDate;return a&&s&&d})}function updateTransactionsTable(){const e=document.getElementById("tbody-tabel");e.innerHTML="";const t=getFilteredTransactions(),n=[...t].map((e,t)=>({...e,originalIndex:transaksi.indexOf(e)})).sort((e,t)=>{const n=new Date(e.tanggal)-new Date(t.tanggal);return 0===n?e.originalIndex-t.originalIndex:n});let a=0;const o=[...n.map(e=>(a+="pemasukan"===e.jenis?e.jumlah:-e.jumlah,{...e,runningBalance:a}))].reverse(),i=10*(currentPage-1),l=i+10,r=o.slice(i,l);if(r.forEach(t=>{let n=t.deskripsi;const a=document.getElementById("search-input").value.toLowerCase().trim();if(a){const e=new RegExp(`(${a})`,"gi");n=t.deskripsi.replace(e,'<mark style="background: rgba(79, 70, 229, 0.2); padding: 0.1rem 0.2rem; border-radius: 3px;">$1</mark>')}const o=document.createElement("tr");o.className="fade-in-up",o.innerHTML=`\n                <td class="text-left">${formatDate(t.tanggal)}</td>\n                <td class="text-left" style="font-weight: 500;">${n}</td>\n                <td class="amount-positive text-right">${"pemasukan"===t.jenis?formatCurrency(t.jumlah):"-"}</td>\n                <td class="amount-negative text-right">${"pengeluaran"===t.jenis?formatCurrency(t.jumlah):"-"}</td>\n                <td class="balance-amount text-right">${formatCurrency(t.runningBalance)}</td>\n                <td class="text-center">\n                    <div class="transaction-actions">\n                        <button class="action-btn edit-btn" onclick="editTransaksi(${t.originalIndex})" data-tooltip="Edit transaksi" tabindex="0">\n                            <div class="action-icon edit-icon"></div>\n                        </button>\n                        <button class="action-btn delete-btn" onclick="hapusTransaksi(${t.originalIndex})" data-tooltip="Hapus transaksi" tabindex="0">\n                            <div class="action-icon delete-icon"></div>\n                        </button>\n                    </div>\n                </td>\n            `,e.appendChild(o)}),updatePaginationControls(t.length),0===r.length&&(document.getElementById("search-input").value.trim()||currentFilteredDate||"semua"!==document.getElementById("filter-bulan").value)){const t=document.createElement("tr");t.innerHTML='<td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Tidak ada hasil untuk filter yang diterapkan. <a href="#" onclick="event.preventDefault(); clearAllFilters();">Hapus filter</a></td>',e.appendChild(t)}}function updatePaginationControls(e){const t=document.getElementById("pagination-controls");t.innerHTML="";const n=Math.ceil(e/10);if(n<=1)return;const a=document.createElement("button");a.innerHTML="&lt;",a.className="pagination-btn",a.disabled=1===currentPage,a.title="Halaman Sebelumnya",a.onclick=()=>{currentPage>1&&(currentPage--,updateUI())},t.appendChild(a);const o=document.createElement("span");o.className="page-info clickable",o.textContent=`${currentPage}/${n}`,o.title="Klik untuk lompat ke halaman",o.onclick=()=>showPageInput(n),t.appendChild(o);const i=document.createElement("button");i.innerHTML="&gt;",i.className="pagination-btn",i.disabled=currentPage===n,i.title="Halaman Berikutnya",i.onclick=()=>{currentPage<n&&(currentPage++,updateUI())},t.appendChild(i)}function showPageInput(e){if(!document.querySelector(".page-info"))return;const t=document.querySelector(".pagination-btn:first-child"),n=document.querySelector(".pagination-btn:last-child"),a=document.getElementById("pagination-controls");a.innerHTML="";const o=document.createElement("input");o.type="number",o.className="pagination-input",o.value=currentPage,o.min=1,o.max=e;o.onkeydown=t=>{"Enter"===t.key?(()=>{let t=parseInt(o.value);t>=1&&t<=e?(currentPage=t,updateUI()):(showNotification(`Masukkan halaman antara 1 dan ${e}`,"error",2e3),updateUI())})():"Escape"===t.key&&updateUI()},o.onblur=()=>{setTimeout(()=>updateUI(),100)},t&&a.appendChild(t),a.appendChild(o),n&&a.appendChild(n),o.focus(),o.select()}function clearAllFilters(){document.getElementById("filter-bulan").value="semua",clearSearch(),clearDateFilter(),showNotification("Semua filter dihapus","info")}function updateMonthFilter(){const e=new Set;transaksi.forEach(t=>e.add(t.tanggal.slice(0,7)));const t=document.getElementById("filter-bulan"),n=t.value,a=document.getElementById("custom-filter-bulan"),o=a.querySelector(".select-selected"),i=a.querySelector(".select-items");t.innerHTML="",i.innerHTML="";const l=(e,n)=>{const a=document.createElement("option");a.value=n,a.innerHTML=e,t.appendChild(a);const l=document.createElement("div");l.innerHTML=e,l.setAttribute("data-value",n),i.appendChild(l),l.addEventListener("click",function(){t.value=this.getAttribute("data-value"),o.innerHTML=this.innerHTML,t.dispatchEvent(new Event("change"))})};l("Semua Bulan","semua"),[...e].sort().reverse().forEach(e=>{l(`Data ${formatMonth(e)}`,e)}),t.value=n;const r=i.querySelector(`[data-value="${t.value}"]`);r&&(o.innerHTML=r.innerHTML)}function editTransaksi(e){if(!checkLoginStatus())return;const t=transaksi[e];document.getElementById("deskripsi").value=t.deskripsi,document.getElementById("jumlah").value=t.jumlah,document.getElementById("tanggal").value=t.tanggal,document.getElementById("jenis").value=t.jenis,editIndex=e,formTitle.textContent="‚úèÔ∏è Edit Transaksi",submitText.textContent="Update Transaksi",cancelEditBtn.style.display="inline-flex",document.querySelector(".form-container").scrollIntoView({behavior:"smooth",block:"start"}),document.getElementById("deskripsi").focus(),showNotification("Mode edit aktif","info")}function hapusTransaksi(e){if(!checkLoginStatus())return;openConfirmationModal(`Yakin ingin menghapus transaksi "${transaksi[e].deskripsi}"?`,()=>{transaksi.splice(e,1),localStorage.setItem("transaksi",JSON.stringify(transaksi)),editIndex===e&&cancelEdit(),updateUI(),showNotification("Transaksi berhasil dihapus","success")})}function openThemeModal(){themeSettingsModal.style.display="flex";updateActiveThemeButton(localStorage.getItem("colorTheme")||"ocean"),updateActiveSwatch()}function closeThemeModal(){themeSettingsModal.style.display="none"}function openDeleteModal(){checkLoginStatus()&&(0!==transaksi.length?(deleteModal.style.display="flex","custom-range"===deleteFilterSelect.value?dateRangeDeleteGroup.style.display="block":dateRangeDeleteGroup.style.display="none"):showNotification("Tidak ada data untuk dihapus!","info"))}function closeDeleteModal(){deleteModal.style.display="none"}function confirmBulkDelete(){const e=document.getElementById("delete-filter").value;let t=[],n="";if("semua"===e)t=[...transaksi],n="semua data";else if("pemasukan"===e)t=transaksi.filter(e=>"pemasukan"===e.jenis),n="data pemasukan";else if("pengeluaran"===e)t=transaksi.filter(e=>"pengeluaran"===e.jenis),n="data pengeluaran";else if("custom-range"===e){const e=deleteStartDateInput.value,a=deleteEndDateInput.value;if(!e||!a)return void showNotification("Pilih tanggal mulai dan tanggal akhir untuk rentang kustom.","error");if(new Date(e)>new Date(a))return void showNotification("Tanggal mulai tidak boleh setelah tanggal akhir.","error");t=transaksi.filter(t=>{const n=new Date(t.tanggal);return n>=new Date(e)&&n<=new Date(a)}),n=`data dari ${formatDate(e)} sampai ${formatDate(a)}`}else t=transaksi.filter(t=>t.tanggal.startsWith(e)),n=`data ${formatMonth(e)}`;if(0===t.length)return void showNotification("Tidak ada data untuk dihapus","info");const a=document.querySelector("#deleteModal .btn-delete-all");openConfirmationModal(`Yakin ingin menghapus ${t.length} transaksi (${n})?`,()=>{a.style.opacity="0.6",a.style.pointerEvents="none",a.querySelector("span:last-child").textContent="Menghapus...",setTimeout(()=>{if("semua"===e)transaksi=[];else if("pemasukan"===e)transaksi=transaksi.filter(e=>"pemasukan"!==e.jenis);else if("pengeluaran"===e)transaksi=transaksi.filter(e=>"pengeluaran"!==e.jenis);else if("custom-range"===e){const e=deleteStartDateInput.value,t=deleteEndDateInput.value;transaksi=transaksi.filter(n=>{const a=new Date(n.tanggal);return!(a>=new Date(e)&&a<=new Date(t))})}else transaksi=transaksi.filter(t=>!t.tanggal.startsWith(e));localStorage.setItem("transaksi",JSON.stringify(transaksi)),closeDeleteModal(),editIndex=null,form.reset(),setTodayDate(),formTitle.textContent="üìù Tambah Transaksi Baru",submitText.textContent="Simpan Transaksi",cancelEditBtn.style.display="none",updateUI(),showNotification(`${t.length} transaksi berhasil dihapus!`,"success"),a.style.opacity="1",a.style.pointerEvents="auto",a.querySelector("span:last-child").textContent="Hapus Data"},800)})}function openPdfSettingsModal(){pdfSettingsModal.style.display="flex";const e=document.getElementById("filter-bulan").value,t=document.getElementById("search-input").value.trim();let n="Laporan Keuangan";"semua"!==e&&(n+=` ${formatMonth(e)}`),currentFilteredDate&&(n+=` Tanggal ${formatDate(currentFilteredDate)}`),t&&(n+=` Pencarian ${t}`),pdfFilenameInput.value=n}function closePdfSettingsModal(){pdfSettingsModal.style.display="none",pdfModalBtn.classList.remove("loading"),pdfModalBtn.querySelector("span:last-child").textContent="Export PDF"}function simpanPDF(){if(0===transaksi.length)return showNotification("Tidak ada data","info"),void closePdfSettingsModal();pdfModalBtn.classList.add("loading"),pdfModalBtn.querySelector("span:last-child").textContent="Generating...",showNotification("Membangun PDF...","info");const e=getFilteredTransactions();if(0===e.length)return showNotification("Tidak ada data untuk periode ini","info"),void closePdfSettingsModal();const t=[...e].map((e,t)=>({...e,originalIndex:transaksi.indexOf(e)})).sort((e,t)=>{const n=new Date(e.tanggal)-new Date(t.tanggal);return 0===n?e.originalIndex-t.originalIndex:n});let n=0;const a=t.map(e=>(n+="pemasukan"===e.jenis?e.jumlah:-e.jumlah,{...e,runningBalance:n}));let o=0,i=0;a.forEach(e=>{"pemasukan"===e.jenis&&(o+=e.jumlah),"pengeluaran"===e.jenis&&(i+=e.jumlah)});const l=o-i,r=document.createElement("table");r.style.width="100%",r.style.borderCollapse="collapse",r.style.fontFamily="Inter, sans-serif",r.style.fontSize="12px",r.style.color="#333",r.innerHTML='\n            <thead>\n                <tr style="background-color: #f0f8ff;">\n                    <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid #a0dfff; color: #333;">Tanggal</th>\n                    <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid #a0dfff; color: #333;">Deskripsi</th>\n                    <th style="padding: 0.8rem; text-align: right; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid #a0dfff; color: #333;">Pemasukan</th>\n                    <th style="padding: 0.8rem; text-align: right; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid #a0dfff; color: #333;">Pengeluaran</th>\n                    <th style="padding: 0.8rem; text-align: right; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid #a0dfff; color: #333;">Saldo</th>\n                </tr>\n            </thead>\n            <tbody></tbody>\n        ';const s=r.querySelector("tbody");a.forEach((e,t)=>{const n=document.createElement("tr");n.style.backgroundColor=t%2==0?"#ffffff":"#f8f8f8",n.innerHTML=`\n                <td style="padding: 0.7rem; border-bottom: 1px solid #eee;">${formatDate(e.tanggal)}</td>\n                <td style="padding: 0.7rem; border-bottom: 1px solid #eee; text-align: left;">${e.deskripsi}</td>\n                <td style="padding: 0.7rem; border-bottom: 1px solid #eee; text-align: right; color: #10b981; font-weight: 500;">${"pemasukan"===e.jenis?formatCurrency(e.jumlah):"-"}</td>\n                <td style="padding: 0.7rem; border-bottom: 1px solid #eee; text-align: right; color: #ef4444; font-weight: 500;">${"pengeluaran"===e.jenis?formatCurrency(e.jumlah):"-"}</td>\n                <td style="padding: 0.7rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600; color: #333;">${formatCurrency(e.runningBalance)}</td>\n            `,s.appendChild(n)});const d=document.createElement("div");d.style.marginTop="2rem",d.style.padding="1.5rem",d.style.backgroundColor="#f8fafc",d.style.borderRadius="8px",d.style.border="1px solid #e2e8f0",d.innerHTML=`\n            <h3 style="font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 1rem; text-align: center;">Ringkasan Keuangan</h3>\n            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">\n                <div style="padding: 1rem; background: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">\n                    <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Total Pemasukan</div>\n                    <div style="font-size: 1.1rem; font-weight: 700; color: #10b981;">${formatCurrency(o)}</div>\n                </div>\n                <div style="padding: 1rem; background: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">\n                    <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Total Pengeluaran</div>\n                    <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">${formatCurrency(i)}</div>\n                </div>\n                <div style="padding: 1rem; background: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">\n                    <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Saldo Akhir</div>\n                    <div style="font-size: 1.1rem; font-weight: 700; color: #333;">${formatCurrency(l)}</div>\n                </div>\n            </div>\n        `;const c=document.getElementById("app-title").textContent,m=document.getElementById("filter-bulan").value,u=document.getElementById("search-input").value.toLowerCase().trim();let g="Semua Periode";"semua"!==m&&(g=formatMonth(m)),u&&(g+=` (Pencarian: "${u}")`),currentFilteredDate&&(g+=` (Pencarian Tanggal: "${formatDate(currentFilteredDate)}")`);const p=document.createElement("div");p.style.textAlign="center",p.style.marginBottom="1.5rem",p.style.fontFamily="Inter, sans-serif",p.innerHTML=`\n            <h1 style="font-size: 20px; color: #1f2937; margin-bottom: 0.75rem;">${c} - Laporan Keuangan</h1>\n            <p style="font-size: 12px; color: #6b7280; margin-bottom: 0.5rem;">Periode: ${g} ‚Ä¢ Dibuat: ${(new Date).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"})}</p>\n            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 1rem 0;">\n        `;const f=document.createElement("div");f.appendChild(p),f.appendChild(r),f.appendChild(d);const y=document.createElement("div");y.style.position="absolute",y.style.left="-9999px",document.body.appendChild(y),y.appendChild(f);const h=pdfOrientationSelect.value;let k=pdfFilenameInput.value.trim();k||(k=`laporan-keuangan-${"semua"===m?"semua-periode":m}`),k+=".pdf";const I={margin:.5,filename:k,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0,windowWidth:document.documentElement.offsetWidth,windowHeight:document.documentElement.offsetHeight},jsPDF:{unit:"in",format:"letter",orientation:h}};html2pdf().set(I).from(f).save().then(()=>{showNotification("PDF berhasil dibuat!","success"),document.body.removeChild(y),closePdfSettingsModal()}).catch(e=>{console.error("Error generating PDF:",e),showNotification("Gagal membuat PDF","error"),document.body.removeChild(y),closePdfSettingsModal()})}document.addEventListener("DOMContentLoaded",function(){initTheme(),loadProfilePhoto(),loadAppTitle(),setTodayDate(),setupMidnightDateUpdate(),setupEventListeners(),initializeCustomSelect(),initializeMonthFilter(),initializePdfOrientationSelect(),document.getElementById("modal-login-form").addEventListener("submit",handleLogin),document.getElementById("close-login-modal-btn").addEventListener("click",closeLoginModal),"true"===localStorage.getItem("isLoggedIn")&&startRealtimeSessionListener(),updateAuthUI(),updateUI()});let notificationId=0;function showNotification(e,t="success",n=3e3){const a=document.getElementById("notification-container"),o=++notificationId;let i;switch(t){case"success":i="‚úì";break;case"error":i="‚úï";break;case"info":i="i";break;case"warning":i="!";break;default:i="‚Ä¢"}const l=document.createElement("div");return l.className=`notification ${t}`,l.id=`notification-${o}`,l.innerHTML=`\n        <div class="notification-icon">${i}</div>\n        <div class="notification-message">${e}</div>\n        <button class="notification-close" onclick="closeNotification(${o})">&times;</button>\n      `,a.appendChild(l),setTimeout(()=>{l.classList.add("show")},50),null!==n&&setTimeout(()=>{closeNotification(o)},n),o}function closeNotification(e){const t=document.getElementById(`notification-${e}`);t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},250))}function debounce(e,t=300){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>{e.apply(this,a)},t)}}function formatCurrency(e){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatDate(e){const t=new Date(e+"T00:00:00");return new Intl.DateTimeFormat("id-ID",{day:"2-digit",month:"long",year:"numeric"}).format(t)}function formatMonth(e){const[t,n]=e.split("-"),a=new Date(t,n-1,1);return new Intl.DateTimeFormat("id-ID",{month:"long",year:"numeric"}).format(a)}function openConfirmationModal(e,t){confirmationModalMessage.textContent=e,currentConfirmCallback=t,confirmationModal.style.display="flex"}function closeConfirmationModal(){confirmationModal.style.display="none",currentConfirmCallback=null}function exportData(){if(0===transaksi.length)return void showNotification("Tidak ada data transaksi untuk diexport.","info");const e=JSON.stringify(transaksi,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a"),o=document.getElementById("app-title").textContent.replace(/\s/g,"-");a.href=n,a.download=`${o}-data-transaksi-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),showNotification("Data transaksi berhasil diexport!","success")}function openImportModal(){checkLoginStatus()&&(importModal.style.display="flex",importFileInput.value="",confirmImportBtn.disabled=!0)}function closeImportModal(){importModal.style.display="none",importFileInput.value="",confirmImportBtn.disabled=!0}function confirmImportData(){const e=importFileInput.files[0];if(!e)return void showNotification("Pilih file JSON untuk diimport.","error");const t=new FileReader;t.onload=function(e){try{const t=JSON.parse(e.target.result);Array.isArray(t)&&t.every(e=>"string"==typeof e.deskripsi&&"number"==typeof e.jumlah&&"string"==typeof e.tanggal&&"string"==typeof e.jenis)?openConfirmationModal("Semua data transaksi yang ada saat ini akan diganti. Lanjutkan?",()=>{transaksi=t,localStorage.setItem("transaksi",JSON.stringify(transaksi)),updateUI(),closeImportModal(),showNotification("Data transaksi berhasil diimport!","success"),editIndex=null,form.reset(),setTodayDate(),formTitle.textContent="üìù Tambah Transaksi Baru",submitText.textContent="Simpan Transaksi",cancelEditBtn.style.display="none"}):showNotification("Format file JSON tidak valid. Pastikan berisi array transaksi dengan properti yang benar.","error")}catch(e){showNotification("Gagal membaca file JSON. Pastikan format file benar dan tidak rusak.","error"),console.error("Error parsing JSON:",e)}},t.onerror=function(){showNotification("Gagal membaca file.","error")},t.readAsText(e)}function scrollToForm(){document.querySelector(".form-container").scrollIntoView({behavior:"smooth",block:"start"})}function initializeCustomSelect(){const e=document.getElementById("custom-jenis");if(!e)return;const t=e.querySelector(".select-selected"),n=document.getElementById("jenis"),a=e.querySelector(".select-items"),o=a.querySelectorAll("div"),i=()=>{e.classList.remove("select-active"),a.classList.add("select-hide")},l=o[1];t.innerHTML=l.innerHTML,n.value=l.getAttribute("data-value"),t.addEventListener("click",function(t){t.stopPropagation();const n=e.classList.contains("select-active");i(),n||(e.classList.add("select-active"),a.classList.remove("select-hide"))}),o.forEach(e=>{e.addEventListener("click",function(){t.innerHTML=this.innerHTML,n.value=this.getAttribute("data-value"),i()})}),document.addEventListener("click",i)}function initializeMonthFilter(){const e=document.getElementById("custom-filter-bulan");if(!e)return;const t=e.querySelector(".select-selected"),n=e.querySelector(".select-items"),a=()=>{e.classList.remove("select-active"),n.classList.add("select-hide")};t.addEventListener("click",function(t){t.stopPropagation();const o=e.classList.contains("select-active");document.querySelectorAll(".custom-select-container").forEach(t=>{t!==e&&(t.classList.remove("select-active"),t.querySelector(".select-items").classList.add("select-hide"))}),o?a():(e.classList.add("select-active"),n.classList.remove("select-hide"))}),document.addEventListener("click",a)}function initializePdfOrientationSelect(){const e=document.getElementById("custom-pdf-orientation");if(!e)return;const t=e.querySelector(".select-selected"),n=document.getElementById("pdf-orientation"),a=e.querySelector(".select-items"),o=a.querySelectorAll("div"),i=()=>{e.classList.remove("select-active"),a.classList.add("select-hide")},l=o[0];t.innerHTML=l.innerHTML,n.value=l.getAttribute("data-value"),t.addEventListener("click",function(t){t.stopPropagation();const n=e.classList.contains("select-active");document.querySelectorAll(".custom-select-container").forEach(t=>{t!==e&&(t.classList.remove("select-active"),t.querySelector(".select-items").classList.add("select-hide"))}),n?i():(e.classList.add("select-active"),a.classList.remove("select-hide"))}),o.forEach(e=>{e.addEventListener("click",function(){t.innerHTML=this.innerHTML,n.value=this.getAttribute("data-value"),i()})}),document.addEventListener("click",i)}function showLoginModal(){document.getElementById("login-modal").style.display="flex",document.getElementById("modal-kode").focus()}function closeLoginModal(){document.getElementById("login-modal").style.display="none",document.getElementById("modal-error-message").style.display="none",document.getElementById("modal-kode").value=""}function getDeviceId(){let e=localStorage.getItem("myBudgetlyDeviceId");return e||(e=crypto.randomUUID(),localStorage.setItem("myBudgetlyDeviceId",e)),e}async function handleLogin(e){e.preventDefault();const t=document.getElementById("modal-kode"),n=document.getElementById("modal-error-message"),a=t.value.trim(),o=getDeviceId(),i=document.querySelector(".login-button");i.disabled=!0,i.textContent="Memverifikasi...";try{const{data:e,error:i}=await supabase.functions.invoke("aktivasi-perangkat",{body:{code:a,deviceId:o}});if(i)throw i;e&&e.success?(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("myAccessCode",a),localStorage.setItem("myDeviceId",o),closeLoginModal(),updateAuthUI(),updateUI(),showNotification("Login berhasil! Selamat datang.","success"),startRealtimeSessionListener()):(n.textContent=e&&e.message||"Kode tidak valid atau sudah digunakan.",n.style.display="block",t.value="",t.focus())}catch(e){console.error("Login API error:",e),n.textContent="Gagal terhubung ke server. Coba lagi nanti.",n.style.display="block"}finally{i.disabled=!1,i.textContent="Masuk"}}async function startRealtimeSessionListener(){const e=localStorage.getItem("myAccessCode");e&&(realtimeChannel&&(await realtimeChannel.unsubscribe(),realtimeChannel=null),console.log(`Mulai mendengarkan perubahan pada kode: ${e}`),realtimeChannel=supabase.channel(`access-code-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"kode_akses",filter:`kode=eq.${e}`},e=>{console.log("Perubahan database terdeteksi:",e),"DELETE"===e.eventType?(console.log("Kode akses telah DIHAPUS dari server!"),showNotification("Sesi Anda telah berakhir (kode dihapus).","error"),handleLogout()):"UPDATE"===e.eventType&&(e.old.kode!==e.new.kode?(console.log(`Kode akses telah DIUBAH dari '${e.old.kode}' menjadi '${e.new.kode}'!`),showNotification("Sesi Anda telah berakhir (kode diubah).","error"),handleLogout()):console.log("Data kode diupdate, tapi kodenya tidak berubah. Sesi lanjut."))}).subscribe((e,t)=>{"SUBSCRIBED"===e&&console.log("Berhasil terhubung ke Realtime untuk session listener."),("CHANNEL_ERROR"===e||t)&&console.error("Koneksi Realtime gagal:",t)}))}async function forceLogout(e){console.warn(`Force logout dipicu: ${e}`),realtimeChannel&&(await supabaseRealtimeClient.removeChannel(realtimeChannel),realtimeChannel=null),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("myAccessCode"),localStorage.removeItem("myDeviceId"),updateAuthUI(),updateUI(),showNotification(e,"error",6e3)}async function handleLogout(){const e=localStorage.getItem("myAccessCode"),t=document.getElementById("auth-button");t&&(t.disabled=!0),realtimeChannel&&(await supabaseRealtimeClient.removeChannel(realtimeChannel),realtimeChannel=null);try{if(e){const t=getDeviceId(),{error:n}=await supabase.functions.invoke("nonaktifkan-perangkat",{body:{code:e,deviceId:t}});if(n)throw n}}catch(e){console.error("Gagal menghubungi server untuk rilis kode:",e)}finally{localStorage.removeItem("isLoggedIn"),localStorage.removeItem("myAccessCode"),localStorage.removeItem("myDeviceId"),t&&(t.disabled=!1),updateAuthUI(),updateUI(),showNotification("Anda telah logout.","info"),document.getElementById("settings-menu").classList.remove("open")}}function updateAuthUI(){const e=document.getElementById("auth-button"),t=e.querySelector("span");"true"===localStorage.getItem("isLoggedIn")?(t.textContent="Logout",e.onclick=handleLogout):(t.textContent="Login",e.onclick=showLoginModal)}function checkLoginStatus(){return"true"===localStorage.getItem("isLoggedIn")||(showLoginModal(),!1)}function loadGuestUI(){document.getElementById("pemasukan").textContent=formatCurrency(0),document.getElementById("pengeluaran").textContent=formatCurrency(0),document.getElementById("saldo").textContent=formatCurrency(0);document.getElementById("tbody-tabel").innerHTML="";const e=document.getElementById("empty-state");e.style.display="block",e.innerHTML='\n        <div class="empty-state-icon">üëã</div>\n        <h2>Selamat Datang di MyBudgetly</h2>\n        \n        <p style="font-size: 1.05rem; max-width: 550px; margin: 0 auto; line-height: 1.6; color: var(--text-secondary);">\n            Ini adalah mode demo, miliki aplikasi <b>MyBudgetly</b> versi lengkap di\n            <a href="https://lynk.id/arul.n11" target="_blank" rel="noopener noreferrer" \n               style="color: var(--primary-accent-color); \n                      font-weight: 600; \n                      text-decoration: underline;\n                      text-decoration-thickness: 2px;">\n                lynk.id/arul.n11\n            </a>\n        </p>\n    ',document.querySelector(".table-container table").style.display="none",document.getElementById("pagination-controls").innerHTML=""}function getTextColorForBackground(e){try{let t=e.replace(/^#/,"");3===t.length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);const n=parseInt(t.substring(0,2),16),a=parseInt(t.substring(2,4),16),o=parseInt(t.substring(4,6),16);return(299*n+587*a+114*o)/1e3>149?"#1f2937":"#ffffff"}catch(e){return console.error("Gagal menghitung warna teks:",e),"#ffffff"}}function applyCustomColor(e){const t=generateGradient(e),n=hexToRgba(e,.15),a=getTextColorForBackground(e),o=document.documentElement.style;o.setProperty("--primary-gradient",t),o.setProperty("--primary-accent-color",e),o.setProperty("--primary-accent-color-glow",n),o.setProperty("--primary-btn-text-color",a),document.documentElement.setAttribute("data-color-theme","custom"),localStorage.setItem("colorTheme","custom"),localStorage.setItem("customAccentColor",e),updateActiveThemeButton(null),updateActiveSwatch()}document.addEventListener("keydown",function(e){(e.ctrlKey||e.metaKey)&&"n"===e.key&&(e.preventDefault(),scrollToForm(),document.getElementById("deskripsi").focus()),"Escape"===e.key&&null!==editIndex&&cancelEdit(),"Escape"===e.key&&("flex"===themeSettingsModal.style.display&&closeThemeModal(),"flex"===pdfSettingsModal.style.display&&closePdfSettingsModal(),"flex"===deleteModal.style.display&&closeDeleteModal(),"flex"===importModal.style.display&&closeImportModal(),document.getElementById("title-edit-modal").classList.contains("show")&&closeTitleEditModal(),"flex"===confirmationModal.style.display&&closeConfirmationModal(),dataActionsDropdown.classList.contains("open")&&dataActionsDropdown.classList.remove("open"),"flex"===document.getElementById("scan-modal").style.display&&closeScanner())});